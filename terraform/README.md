# Terraform

The persistent AWS infrastructure is deployed as Cloud.gov assets via Terraform. For a description of persistent infrastructure and how it differs from ephemeral infrastructure see the root README.md.

## Set up

### Installation

On MacOS:

```bash
brew install terraform
```
On other platforms:

[Download and install terraform][tf]

### Use githook for formatting

Terraform has a specific formatting style that is difficult to maintain. Terraform includes a formatting command, `terraform fmt`, to help developers maintain the correct style. This repository contains a pre-commit hook that runs `terraform fmt` on all staged files so you don't have to remember to run this command.

If you are not using your own custom pre-commit hooks, start using this hook by simply changing your default hooks directory to `.githooks`.

```bash
# from repo root directory
chmod 755 .githooks/pre-commit
git config core.hooksPath .githooks
```

If you are already using git hooks, add the `.githooks/pre-commit` contents to your hooks directory or current pre-commit hook. Remember to make the file executable.

### Credentials

We are using Terraform to create Cloud.gov resources. Creating infrastructure on the Cloud.gov platform requires a Cloud.gov deployer account username and password. These keys are specific to each cloud.gov organization/space, i.e. each deployment environment, and can be [regenerated by developers][cloudgov-deployer] who have proper cloud.gov permissions at any time. These are the same credentials that are stored in CircleCI as "environment variables" and are used for the deployment pipeline. This means, **if you regenerate deployer credentials you will need to update the username and password "environment variables" in CircleCI as well**.

Place your Cloud.gov deployer credentials in terraform/secrets.auto.tfvars

Your `terraform/secrets.auto.tfvars` file should look something like this:

```

```

## Terraform workflow

**You run terraform files from the directory in which they are stored. For example, you could run all the commands below from `terraform/dev`.**

1. Initialize

    The first time you are working in a new environment, for example, after cloning this repository, you will need to initialize a working directory containing Terraform configuration files using the `init` command. It is safe to run this command multiple times.

    ```bash
    terraform init
    ```

1. Check that your state is clean

    Terraform configuration files committed to the `main` branch should describe the infrastructure that is currently in use. This is described as a "clean state". Use the `plan` command to display a list of infrastructure that Terraform will need to update, delete or create to match what is in your local Terraform configuration files.
      - If state is clean, `plan` will not display any changes.
      - If state is not clean reach out to your fellow developers for clarification and advice on how to proceed. It is very likely that changes were accidentally applied and a developer is currently working on a fix.

    ```bash
    terraform plan
    ```

1. Make changes and get feedback

    Make any needed changes to your local Terraform configuration files.  Open a PR for those changes.  In your PR include the output from `terraform plan` so reviewers can see what resources will be updated, created and destroyed.

1. Merge and apply changes

    _Tip: Before you merge your PR ensure you have enough time to sit and work through any unexpected problems that could arise._

    Merge your PR into `main` and then **immediately afterwards** apply your changes. Always merge and apply in one sitting.

    ```bash
    terraform apply
    ```

<!-- Links -->

[cloudgov-deployer]: https://cloud.gov/docs/services/cloud-gov-service-account/
[tf]: https://www.terraform.io/downloads.html

